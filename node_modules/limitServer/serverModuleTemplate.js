"use strict";
/**
 * 模板规则
 * control/test 同级目录下的
 * test:control/test test目录下的
 * layout/test 同级目录下的
 * test:layout/test test目录下的
 */
const fs = require('fs');
const ejs = require('ejs');

// 模板类
class ServerModuleTemplate {
	constructor(path){
		let me = this;
		me.path = path;
		me.getLayoutTplPath();
		return me.replaceLayoutBody();
	}
	// 获取布局模板地址
	getLayoutTplPath(){
		let me = this;
		let path = me.path;
		// 解析原模板，有没有设置模板
		let match = fs.readFileSync(path, 'utf-8').match(/layout\s+([^\s%]+)/);
		if( match && match[1] ){
			path = path.split('templates')[0];
			me.layoutPath = `${path}templates/${match[1]}.ejs`;
		}else{
			path = path.split('screen')[0];
			me.layoutPath = `${path}layout/main.ejs`;
		};
	}
	// 替换布局模板里面的主body
	replaceLayoutBody(){
		let me = this;
		let latoutHtml = fs.readFileSync(me.layoutPath, 'utf-8');
		latoutHtml = latoutHtml.replace(/(<%\s*include\s+)body(\s+%>)/, `$1${me.path}$2`);
		return ejs.compile( latoutHtml, {
			filename: me.path
		} );
	}
};

module.exports = ServerModuleTemplate;